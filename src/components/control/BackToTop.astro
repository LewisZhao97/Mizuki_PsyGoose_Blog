---
import { Icon } from "astro-icon/components";
---

<div class="back-to-top-wrapper hidden lg:block">
	<div id="back-to-top-btn" class="back-to-top-btn hide flex items-center justify-center rounded-2xl overflow-visible transition" onclick="backToTop()">
		<button aria-label="Back to Top" class="btn-card h-[3.75rem] w-[3.75rem] rounded-2xl relative flex flex-col items-center justify-center">
			<svg class="progress-ring" width="60" height="60" viewBox="0 0 60 60">
				<rect
					class="progress-ring-bg"
					x="1.5"
					y="1.5"
					width="57"
					height="57"
					rx="16"
					fill="none"
					stroke-width="3"
				/>
				<rect
					id="progress-ring-path"
					class="progress-ring-path"
					x="1.5"
					y="1.5"
					width="57"
					height="57"
					rx="16"
					fill="none"
					stroke-width="3"
					stroke-dasharray="200.53"
					stroke-dashoffset="200.53"
				/>
			</svg>

			<div class="icon-wrapper relative z-10">
				<Icon name="material-symbols:keyboard-arrow-up-rounded" class="text-[1.75rem]"></Icon>
			</div>
		</button>
	</div>
</div>

<style lang="stylus">
	.back-to-top-wrapper
		width: 3.75rem
		height: 3.75rem
		position: absolute
		right: 0
		top: 0
		pointer-events: none

	.back-to-top-btn
		color: var(--primary)
		font-size: 2.25rem
		font-weight: bold
		border: none
		position: fixed
		bottom: 5.5rem
		right: 1.1rem
		opacity: 1
		cursor: pointer
		/* 初始状态：移出屏幕 */
		transform: translateX(0)
		pointer-events: auto
		z-index: 90
		transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out

		/* 隐藏状态 */
		&.hide
			transform: translateX(5rem)
			opacity: 0
			pointer-events: none

		/* 点击态 */
		&:active
			transform: scale(0.9)

		button
			position: relative
			/* 移除 overflow hidden 以显示 SVG 描边 */
			overflow: visible

		/* SVG 容器 */
		.progress-ring
			position: absolute
			top: 0
			left: 0
			width: 100%
			height: 100%
			pointer-events: none
			/* 旋转 -90度，让进度条从顶部开始 */
			transform: rotate(-90deg)
			z-index: 1

		/* 轨道背景色 */
		.progress-ring-bg
			stroke: var(--btn-content)
			opacity: 0.1

		/* 进度条颜色 */
		.progress-ring-path
			stroke: var(--primary)
			transition: stroke-dashoffset 0.1s linear
			stroke-linecap: round

		.icon-wrapper
			display: flex
			align-items: center
			justify-content: center

	@media (max-width: 1560px)
		.back-to-top-btn
			box-shadow: none

	@media (max-width: 768px)
		.back-to-top-wrapper
			display: none
</style>

<script is:raw is:inline>
	// 定义全局点击函数
		function backToTop() {
			window.scroll({ top: 0, behavior: 'smooth' });
			}

		// 初始化逻辑封装
		function initBackToTop() {
			const SCROLL_THRESHOLD_PX = 300; // 滚动多少像素后显示按钮
			const progressPath = document.getElementById('progress-ring-path');
			const backToTopBtn = document.getElementById('back-to-top-btn');

			if (!progressPath || !backToTopBtn) return;

			// 圆角矩形周长 (57x57, rx=16)
			const perimeter = 200.53;

			function updateProgress() {
				const scrollTop = window.scrollY || document.documentElement.scrollTop;
				const viewportHeight = window.innerHeight;
				const docHeight = document.documentElement.scrollHeight;

				// 1. 计算阅读进度
				let progress = 0;
				const postContainer = document.getElementById('post-container'); // 确保你的文章容器ID也是这个

				if (postContainer) {
					// --- 文章模式 ---
					const containerRect = postContainer.getBoundingClientRect();
					const containerTopAbsolute = containerRect.top + scrollTop;
					const containerHeight = containerRect.height;

					// 计算视口底部相对于文章顶部的距离
					const currentPos = scrollTop + viewportHeight - containerTopAbsolute;

					// 只有当进入文章区域后才开始计算
					if (currentPos > 0) {
						progress = currentPos / containerHeight;
						}
					} else {
					// --- 全局回退模式 (首页或无文章容器页) ---
					const scrollableHeight = docHeight - viewportHeight;
					if (scrollableHeight > 0) {
						progress = scrollTop / scrollableHeight;
						}
					}

				// 限制进度在 0 到 1 之间
				progress = Math.min(Math.max(progress, 0), 1);

				// 2. 更新 SVG Dashoffset
				// stroke-dasharray 是实线长+间隙长。这里我们只用实线，通过 offset 控制显示长度
				const offset = perimeter - (progress * perimeter);
				progressPath.style.strokeDashoffset = offset.toString();

				// 3. 控制按钮显隐
				if (scrollTop > SCROLL_THRESHOLD_PX) {
					backToTopBtn.classList.remove('hide');
					} else {
					backToTopBtn.classList.add('hide');
					}
				}

			// 添加滚动监听
			window.addEventListener('scroll', updateProgress, { passive: true });
			// 初始化运行一次
			updateProgress();
			}

		// 立即运行 (针对首次加载)
		initBackToTop();

		// 适配 Astro View Transitions (页面切换后重新绑定)
		document.addEventListener('astro:page-load', initBackToTop);
</script>