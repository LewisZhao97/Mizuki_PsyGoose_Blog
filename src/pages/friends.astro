---
import { getEntry, render } from "astro:content";
import Markdown from "@components/misc/Markdown.astro";
import Comment from "@components/comment/index.astro";
// import Icon from "../components/misc/Icon.astro";
import { siteConfig } from "../config";
import { getShuffledFriendsList } from "../data/friends";
import I18nKey from "../i18n/i18nKey";
import { i18n } from "../i18n/translation";
import MainGridLayout from "../layouts/MainGridLayout.astro";

// 检查友链页面是否启用
if (!siteConfig.featurePages.friends) {
	return Astro.redirect("/404/");
}

const friendsPost = await getEntry("spec", "friends");

if (!friendsPost) {
	throw new Error("friends page content not found");
}

const { Content } = await render(friendsPost);
const friendsList = getShuffledFriendsList();

// 获取所有标签
const allTags = Array.from(new Set(friendsList.flatMap((item) => item.tags)));
---

<MainGridLayout title={i18n(I18nKey.friends)} description={i18n(I18nKey.friends)}>
	<!-- 只在友情链接页面加载脚本 -->
	<script is:inline>
		// 标记当前页面为友情链接页面
		window.isFriendsPage = true;
	</script>
	<script>
		import('../scripts/right-sidebar-layout.js');
	</script>
	<div class="flex w-full rounded-[var(--radius-large)] overflow-hidden relative min-h-32 mb-4">
		<div class="card-base z-10 px-9 py-6 relative w-full">
			<!-- 页面标题 -->
			<div class="flex flex-col items-start justify-center mb-8">
				<h1 class="text-4xl font-bold text-black/90 dark:text-white/90 mb-2 relative
                  before:w-1 before:h-8 before:rounded-md before:bg-[var(--primary)]
                  before:absolute before:top-1/2 before:-translate-y-1/2 before:-left-4">
					{i18n(I18nKey.friends)}
				</h1>
				<p class="text-lg text-black/60 dark:text-white/60">
					{i18n(I18nKey.friendsSubtitle)}
				</p>
			</div>

			<!-- 搜索和筛选栏 -->
			<div class="mb-6 space-y-3">
				<!-- 搜索框 -->
				<div class="w-full">
					<div class="relative">
						<input
							type="text"
							id="friend-search"
							placeholder={i18n(I18nKey.friendsSearchPlaceholder)}
							class="w-full px-4 py-2 pl-10 rounded-lg bg-[var(--btn-regular-bg)] 
									text-black/90 dark:text-white/90
									border border-black/10 dark:border-white/10
									focus:outline-none focus:ring-2 focus:ring-[var(--primary)]/50
									transition-all duration-200"
						/>
						<svg class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-black/40 dark:text-white/40"
							 fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
								  d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
						</svg>
					</div>
				</div>

				<!-- 标签筛选 -->
				<div class="filter-container flex flex-wrap gap-2">
					<button
						class="filter-tag active"
						data-tag="all"
					>
						{i18n(I18nKey.friendsFilterAll)}
					</button>
					{allTags.map(tag => (
						<button
							class="filter-tag"
							data-tag={tag}
						>
							{tag}
						</button>
					))}
				</div>
			</div>

			<!-- 友链卡片网格 -->
			<div id="friends-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-2 xl:grid-cols-3 gap-5 mb-6">
				{friendsList.map((item) => (
					<a
						href={item.siteurl}
						target="_blank"
						rel="noopener noreferrer"
						class="friend-card group relative flex flex-col p-4 rounded-xl
                          bg-[var(--card-bg)]/50 backdrop-blur-md
                          border border-black/10 dark:border-white/10
                          overflow-hidden transition-all duration-300
                          hover:-translate-y-1
                          hover:border-[var(--primary)]
                          hover:bg-[var(--primary)]/5"
						data-title={item.title.toLowerCase()}
						data-desc={item.desc.toLowerCase()}
						data-tags={item.tags.join(',')}
					>
						<div class="flex items-center gap-4 mb-3">
							<div class="flex-shrink-0 relative">
								<img
									src={item.imgurl}
									alt={item.title}
									class="w-14 h-14 rounded-full object-cover
                                   bg-gray-200 dark:bg-gray-700
                                   border border-black/5 dark:border-white/10
                                   transition-all duration-300
                                   group-hover:scale-105
                                   group-hover:ring-2 group-hover:ring-[var(--primary)]
                                   group-hover:shadow-[0_0_15px_var(--primary)]"
									loading="lazy"
								/>
							</div>

							<div class="flex-1 min-w-0 flex flex-col justify-center">
								<h3 class="text-lg font-bold text-black/90 dark:text-white/90 truncate
                                     group-hover:text-[var(--primary)] transition-colors duration-300">
									{item.title}
								</h3>
								<p class="text-sm text-black/50 dark:text-white/50 truncate" title={item.desc}>
									{item.desc}
								</p>
							</div>
						</div>

						<div class="flex flex-wrap gap-2 mt-auto pt-2 border-t border-black/5 dark:border-white/5">
							{item.tags.map(tag => (
								<span class="text-xs px-2 py-0.5 rounded-md
                                      bg-black/5 dark:bg-white/10
                                      text-black/60 dark:text-white/60
                                      group-hover:text-[var(--primary)]
                                      group-hover:bg-[var(--primary)]/10
                                      transition-colors duration-300">
                            #{tag}
                         </span>
							))}
						</div>
					</a>
				))}
			</div>

			<!-- 无结果提示 -->
			<div id="no-results" class="hidden text-center py-12">
				<svg class="w-16 h-16 mx-auto mb-4 text-black/20 dark:text-white/20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
						  d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
				</svg>
				<p class="text-black/50 dark:text-white/50 text-lg">{i18n(I18nKey.friendsNoResults)}</p>
			</div>


			<!-- 隐藏元素用于传递 i18n 文本到全局脚本 -->
			<div id="friends-copy-success-text" style="display: none;">{i18n(I18nKey.friendsCopySuccess)}</div>
		</div>
	</div>
	<!--添加friends.md卡片-->
	<div class="flex w-full rounded-[var(--radius-large)] overflow-hidden relative mb-4">
		<div class="card-base z-10 px-9 py-6 relative w-full">
			<Markdown class="prose dark:prose-invert max-w-none">
				<Content />
			</Markdown>
		</div>
	</div>
	<!--添加友链页面评论功能-->
	<div class="mt-4">
		<Comment post={friendsPost as any} />
	</div>
	<!-- 引用全局脚本 -->
	<script is:inline src="/js/friends-page-handler.js"></script>
</MainGridLayout>

<style>
	/* 定义卡片基础背景色 */
	.friend-card {
		--card-bg: rgba(255, 255, 255, 0);
		/* 初始无阴影 */
		box-shadow: 0 0 0 transparent;
		/* 进入动画 */
		animation: fadeInUp 0.5s ease-out forwards;
		opacity: 0;
	}

	:global(.dark) .friend-card {
		--card-bg: rgba(30, 30, 30, 0.4);
	}

	/* 核心：鼠标悬停时的全局泛光 (Bloom Effect) */
	.friend-card:hover {
		/* 利用 CSS 变量实现主要颜色的泛光 */
		box-shadow: 0 0 20px -5px var(--primary);
		/* 如果觉得太亮，可以调低透明度，例如:
		   box-shadow: 0 0 20px -5px rgba(var(--primary-rgb, 59, 130, 246), 0.5);
		   注意：这取决于你的 primary 变量是否支持 rgb 拆分，如果不支持，直接用 var(--primary) 即可
		*/
	}

	/* 动画延迟设置 (保持不变) */
	.friend-card:nth-child(1) { animation-delay: 0.05s; }
	.friend-card:nth-child(2) { animation-delay: 0.1s; }
	.friend-card:nth-child(3) { animation-delay: 0.15s; }
	.friend-card:nth-child(4) { animation-delay: 0.2s; }
	/* ... 更多 */

	@keyframes fadeInUp {
		from { opacity: 0; transform: translateY(20px); }
		to { opacity: 1; transform: translateY(0); }
	}
	/* 搜索框和筛选标签样式保持不变... */
	#friend-search:focus {
		box-shadow: 0 0 0 3px var(--primary) / 0.1;
	}

	.filter-container {
		display: flex;
		flex-wrap: wrap;
		gap: 0.5rem;
	}
	/* ...原有 filter-tag 样式保留... */
	.filter-tag {
		padding: 0.5rem 1rem;
		border: 1px solid var(--line-divider);
		border-radius: var(--radius-large);
		background: var(--btn-regular-bg);
		color: var(--btn-content);
		font-size: 0.875rem;
		font-weight: 500;
		cursor: pointer;
		transition: all 0.2s ease;
		white-space: nowrap;
	}

	.filter-tag:hover:not(.active) {
		background: var(--btn-hover-bg);
		border-color: var(--primary);
		transform: translateY(-1px);
	}

	.filter-tag.active {
		background: var(--primary);
		color: white;
		border-color: var(--primary);
	}
</style>